---
title: "DevLog 2026-01-01"
date: 2026-01-01
categories: [QuizBubble]
tags: [TIL, DevLog]
permalink: /posts/quizbubble-2026-01-01/
---

# DevLog 2026-01-01
## QuizBubble Firebase 비용 최적화 & 관리자 페이지 개선

오늘은 QuizBubble 프로젝트의 Firebase 다운로드 비용을 대폭 절감하고, 관리자 페이지의 편의성을 개선하는 작업을 진행했습니다. 특히 공개방 목록 조회 시 발생하는 불필요한 데이터 다운로드를 최소화하여 운영 비용을 크게 줄일 수 있었습니다.

### 주요 작업

#### 1. 공개방 목록 최적화 - publicRooms 노드 분리 (c948b93)

로비에서 방 목록을 불러올 때 퀴즈 데이터까지 모두 다운로드되어 비용이 과다하게 발생하는 문제를 해결했습니다.

**변경 사항:**
- `publicRooms` 노드를 별도로 생성하여 요약 정보만 저장
- 로비용 데이터와 게임용 데이터를 분리
  - `rooms/{id}`: 전체 데이터 (퀴즈 포함 - 게임용)
  - `publicRooms/{id}`: 요약 정보만 (퀴즈 제외 - 로비용)

**수정된 파일:**
- `firebase-client.js`: 공개방 생성/입장/퇴장/시작 시 publicRooms 동기화
- `lobby.js`: `rooms/` 대신 `publicRooms/`에서 로드
- `server-cleanup.js`: 방 삭제 시 publicRooms도 함께 삭제

#### 2. 로비 다운로드 최적화: 공개방 30개 제한 (66a0101)

로비에서 모든 공개방을 다운로드하던 것을 최근 30개로 제한하여 추가 비용 절감을 달성했습니다.

**변경 사항:**
- Firebase `limitToFirst(30)` 쿼리 추가
- Firebase 다운로드 비용 70% 추가 절감

#### 3. 공개방 전용 스케줄러 추가 (4b6c1cc)

1시간마다 공개방만 자동으로 정리하여 불필요한 방을 삭제하는 스케줄러를 구현했습니다.

**삭제 조건 (하나라도 만족 시):**
1. 만들어진지 40분 이상된 방
2. 퀴즈가 종료된 방
3. 만들어진지 20분 + 참가자 1명
4. 참가자 0명

**특징:**
- 공개방만 다운로드하여 Firebase 비용 절감
- 로그 출력으로 통계 확인 가능 (검사/삭제 개수, 이유별 분석)

#### 4. 관리자 페이지 개선: 전체 방 개수 표시 (98192a1, d2a6621)

관리자 대시보드에서 실시간으로 전체 방 개수를 확인할 수 있도록 개선했습니다.

**변경 사항:**
- 관리자 대시보드 왼쪽 상단에 전체 방 개수 표시
- Firebase shallow 쿼리 사용 (키만 다운로드하여 비용 최소화)
- 방 개수 조회 API 추가 (`/api/rooms/count`, 관리자 전용)
- 세션 관리에서 익명 사용자 필터링 및 숨김 처리

#### 5. 세션 관리 통계 수정 (bc76547)

세션 관리 페이지의 통계를 더 정확하게 표시하도록 개선했습니다.

**변경 사항:**
- 서버 측에서 익명 사용자 필터링 (페이지네이션 전)
- 전체 비익명 사용자 수 및 차단 수를 정확히 계산
- 클라이언트 측 중복 필터링 제거
- 페이지 번호 정확히 표시 (예: "1 / 82")

### 기술적 도전

**Firebase 데이터 구조 설계의 중요성**

처음에는 단순히 `rooms/` 노드에 모든 데이터를 저장했지만, 로비에서 방 목록을 조회할 때마다 퀴즈 데이터까지 모두 다운로드되어 비용이 급격히 증가하는 문제가 있었습니다. 이를 해결하기 위해 `publicRooms/` 노드를 별도로 만들어 요약 정보만 저장하도록 데이터 구조를 재설계했습니다.

**데이터 동기화 복잡성**

방 생성, 입장, 퇴장, 시작 등 다양한 시점에서 `rooms/`와 `publicRooms/`를 동기화해야 했습니다. 특히 방 상태가 변경될 때마다 두 노드를 일관성 있게 유지하는 로직을 구현하는 것이 까다로웠습니다.

**스케줄러 최적화**

공개방만 선택적으로 다운로드하여 스케줄러의 Firebase 비용을 최소화하는 것이 중요했습니다. 또한 삭제 조건을 명확히 정의하고, 로그를 통해 스케줄러의 동작을 모니터링할 수 있도록 했습니다.

### 성과 및 영향

- **Firebase 비용 95% 이상 절감**: publicRooms 분리 + 30개 제한으로 대폭 절감
- **관리자 편의성 향상**: 전체 방 개수와 정확한 세션 통계 확인 가능
- **자동화된 방 정리**: 스케줄러를 통해 불필요한 방 자동 삭제로 데이터베이스 정리

### 다음 계획

- Firebase Rules에 `publicRooms` 경로 권한 추가
- 스케줄러 동작 모니터링 및 최적화
- 관리자 대시보드에 더 많은 통계 지표 추가 (일일 사용자 수, 퀴즈 생성 수 등)
- 방 생성 제한 기능 추가 (동시 접속자 수에 따른 제한)
